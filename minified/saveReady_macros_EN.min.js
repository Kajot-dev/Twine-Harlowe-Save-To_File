const privateSave={cheatPassage:!1,binKey:3,maxFileSize:512,extension:"sav",a:(o,p)=>(p="function"==typeof p?p:()=>{},"string"==typeof o?$(Selectors.story).append(Dialog(o,void 0,p)):null),b:o=>{var p=[],r;for(let r in localStorage)!0===privateSave.l(r,!0,!1,!0)&&r.slice(49).trim()===o&&p.push(r,localStorage.getItem(r));return p.length>=2?p.join("\n"):null},c:o=>{let p=State.serialise();return"string"==typeof p?"(Saved Game "+privateSave.s+") "+o+"\n"+p:null},d:(o,p,r)=>{if(!o||!p||!r)return null;var s=new Blob([o],{type:p}),t=document.createElement("a");t.setAttribute("download",r),t.setAttribute("id","savedownload"),t.setAttribute("href",URL.createObjectURL(s)),t.dataset.downloadurl=[p,t.download,t.href].join(":"),t.style.display="none",t.click(),setTimeout((function(){URL.revokeObjectURL(t.href)}),1500)},e:o=>{let p=privateSave.s.split("-");o=privateSave.j(o,p[4]);let r=privateSave.g(o,p[0]);return o=privateSave.h(o,r,p[1]+p[2]),o=privateSave.k(o,privateSave.binKey)},f:o=>{let p=privateSave.s.split("-");o=privateSave.k(o,privateSave.binKey);let[r,s]=privateSave.i(o,p[0].length,p[1]+p[2]);o=r;let t=privateSave.j(o,p[4],!0),u=privateSave.l(t,!1,!0,!1);return!0===u?s===privateSave.g(o,p[0])?o=t:[null,"cheater"]:[null,u]},g:(o,p)=>{for(var r=p.split("").map(x=>x.charCodeAt(0));o.length%p.length!=0;)o+=".";for(let i=0;i<o.length/p.length;i++)for(let j=0;j<p.length;j++)r[j]=(r[j]+o.charCodeAt(i*p.length+j))%128;var s="";for(let i=0;i<p.length;i++)s+=String.fromCharCode(65+r[i]%26);return s},h:(o,p,r)=>{for(;r.length<p.length;)r+=r;var s=(r=r.slice(0,p.length)).split("").map(x=>x.charCodeAt(0));for(let i=0;i<p.length;i++)s[i]<o.length?o=o.slice(0,s[i])+p[i]+o.slice(s[i]):o+=p[i];return o},i:(o,p,r)=>{for(;r.length<p;)r+=r;var s=(r=r.slice(0,p)).split("").map(x=>x.charCodeAt(0)).reverse(),t="";for(let i=0;i<p;i++)s[i]<o.length?(t+=o[s[i]],o=o.slice(0,s[i])+o.slice(s[i]+1)):(t+=o[o.length-1],o=o.slice(0,-1));return[o,t=t.split("").reverse().join("")]},j:(o,p,r)=>{p=p.length<=o.length?p:p.slice(0,o.length);let s=0;var t="";for(let i=0;i<o.length;i++)if(privateSave.r.includes(o[i])){let x=privateSave.r.indexOf(o[i]),y=privateSave.r.indexOf(p[(i-s)%p.length]);r?(x-=y,x<0&&(x+=privateSave.r.length)):x=(x+y)%privateSave.r.length,t+=privateSave.r[x]}else t+=o[i],s++;return t},k:(o,p)=>{if("number"!=typeof p)return o;p=p.toString();var t="";o=o.toString();for(let i=0;i<o.length;i++){let r,s=o.charCodeAt(i)^p;t+=String.fromCharCode(s)}return t},l:(o,p,r,s)=>{let t=(o=o.includes("\n")?o.split("\n")[0]:o).includes("Filename")?o.slice(21,57).trim():o.slice(12,48).trim();return p=!p||!o.includes("Filename"),s=!!s&&"Saved Game"!==o.slice(1,11).trim(),"("!==o[0]||" "!==o[6]||" "!==o[11]||s?(r&&privateSave.a("This is not a Twine save... is it?"),"corrupted_save_name"):t!==privateSave.s?(r&&privateSave.a("I can't open this save, it's from another Twine game!"),"wrong_id"):!!p||"wrong_save_key"},m:(o,p,r)=>new Promise((a,b)=>{r=Array.isArray(r)?r:[r];var s=o.files[o.files.length-1];if(s.name.slice(s.name.lastIndexOf(".")+1).toLowerCase()!==privateSave.extension)return privateSave.a("Wrong extension, correct one is: ."+privateSave.extension),void b("wrong_extension");if(!s||s.size/1024>privateSave.maxFileSize)return privateSave.a("File too large (or your browser couldn'y provide it)"),void b("none/too_large");var t=new FileReader;t.readAsText(s),t.onload=c=>{let u=c.target.result;if(u.length<=50)return privateSave.a("Empty/too short file!"),void b("empty/too_short");if(u=privateSave.f(u),Array.isArray(u))return void b(u[1]);if("Saved Game"!==u.slice(1,11))return privateSave.a("I can't load this save - is this even a save file?"),void b("no_phrase");var w=u.split("\n");if(w.length<2)return privateSave.a("I can't load this save - can't unpack it!"),void b("no_line_break");let x;var y=w[0].slice("49").trim();r.includes(y)?State.deserialise(w[1])instanceof Error?(privateSave.a("Save corrupted - Twine refused loading it!"),b("corrupted_save_data")):(localStorage.setItem("(Saved Game "+privateSave.s+") "+p,w[1]),a(!0)):(privateSave.a("I'm not allowed to load this save!"),b("wrong_slot"))},t.onerror=()=>{privateSave.a("Error reading the file!"),b("file_error")}}),n:(o,p)=>{var r=privateSave.b(p);r?(r=privateSave.e(r),privateSave.d(r,"text/plain",o+"."+privateSave.extension)):(privateSave.a("I can't download save which doesn't exists!"),console.error(...privateSave.t,"I can't download save which doesn't exists!"))},o:(o,p)=>{let r=privateSave.c(p);if("null"==typeof r)return privateSave.a("I couldn't download save - probably Twine's error!"),null;r=privateSave.e(r),privateSave.d(r,"text/plain",o+"."+privateSave.extension)},p:(o,p)=>{var r=$("#saveupload")[0];r||((r=document.createElement("input")).setAttribute("type","file"),r.setAttribute("id","saveupload"),r.style.display="none",r.setAttribute("accept","*."+privateSave.extension),r.setAttribute("size","1"),$(Selectors.passage).append(r)),r.addEventListener("change",()=>{privateSave.m(r,o,p).then(()=>{r.remove(),Engine.showPassage(State.passage),console.log(...privateSave.t,"Reading from file was succesful!")}).catch(s=>{r.remove(),console.error(...privateSave.t,"Reading from file failed, because:",s),"cheater"==s&&(privateSave.cheatPassage?Engine.goToPassage(privateSave.cheatPassage):privateSave.a("Cheater!"))})},{once:!0}),r.click()},r:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",s:$("tw-storydata").attr("ifid"),t:["%cSAVE TO FILE:","font-weight: bold"]};Object.freeze(privateSave),console.info(privateSave.t[0]+"%c Save to file script is ready!",privateSave.t[1],"color: green;");const Macros=require("macros");Macros.add("readfromfile",(function(...a){if(a.length>1){let b=[];b=a.length>2?a.slice(2,a.length):[a[1]],privateSave.p(a[1],b)}return{TwineScript_TypeName:"a (readfromfile:) operation",TwineScript_ObjectName:"a (readfromfile:) operation",TwineScript_Print:function(){return""}}}),[String,Macros.TypeSignature.zeroOrMore(String)]),Macros.add("savetofile",(function(_,n,s){for(n=n.trim();"."==n[n.length-1];)n=n.slice(0,n.length-1);return""===n?null:(privateSave.n(n,s),{TwineScript_TypeName:"a (savetofile:) operation",TwineScript_ObjectName:"a (savetofile:) operation",TwineScript_Print:function(){return""}})}),[String,String]),Macros.add("savetofiledirect",(function(_,n,s){for(n=n.trim();"."==n[n.length-1];)n=n.slice(0,n.length-1);return""===n?null:(privateSave.o(n,s),{TwineScript_TypeName:"a (savetofiledirect:) operation",TwineScript_ObjectName:"a (savetofiledirect:) operation",TwineScript_Print:function(){return""}})}),[String,String]);
