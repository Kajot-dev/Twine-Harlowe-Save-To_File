"use strict";let saveInput;const{dialog}=require("utils/renderutils"),privateSave={//---CONFIGURABLES---
cheatPassage:!1,//string or false boolean
binKey:3,maxFileSize:512,//KB
extension:"sav",//lowercase and without '.'
//---END OF CONFIGURABLES---
openDialog:(a,b)=>(b="function"==typeof b?b:()=>{},"string"==typeof a?$("tw-story").append(dialog({message:a,buttons:[{name:"OK",callback(){b()}}]})):null),get:a=>{var b=[];for(let c of Object.keys(localStorage))!0===privateSave.verify(c,!0,!1,!0)&&c.slice(49).trim()===a&&b.push(c,localStorage.getItem(c));if(2<=b.length){var c=b.join("\n");return c}return null},getDirect:a=>{let b=State.serialise();return"string"==typeof b?"(Saved Game "+privateSave.storyUID+") "+a+"\n"+b:null},download:(a,b,c)=>{if(!a||!b||!c)return null;var d=new Blob([a],{type:b}),e=document.createElement("a");e.setAttribute("download",c),e.setAttribute("id","savedownload"),e.setAttribute("href",URL.createObjectURL(d)),e.dataset.downloadurl=[b,e.download,e.href].join(":"),e.style.display="none",e.click(),setTimeout(function(){URL.revokeObjectURL(e.href)},1500)},encode:a=>{let b=privateSave.storyUID.split("-");a=privateSave.vigenere(a,b[4]);let c=privateSave.checkSum(a,b[0]);return a=privateSave.insertCheckSum(a,c,b[1]+b[2]),a=privateSave.encodeBin(a,privateSave.binKey),a},decode:a=>{let b=privateSave.storyUID.split("-");a=privateSave.encodeBin(a,privateSave.binKey);let[c,d]=privateSave.pullCheckSum(a,b[0].length,b[1]+b[2]);a=c;let e=privateSave.vigenere(a,b[4],!0),f=privateSave.verify(e,!1,!0,!1);return!0===f?d===privateSave.checkSum(a,b[0])?(a=e,a):[null,"cheater"]:[null,f]},checkSum:(a,b)=>{for(var c=b.split("").map(a=>a.charCodeAt(0));0!=a.length%b.length;)a+=".";for(let d=0;d<a.length/b.length;d++)for(let e=0;e<b.length;e++)c[e]=(c[e]+a.charCodeAt(d*b.length+e))%128;var d="";for(let e=0;e<b.length;e++)d+=String.fromCharCode(65+c[e]%26);return d},insertCheckSum:(a,b,c)=>{for(;c.length<b.length;)c+=c;c=c.slice(0,b.length);var d=c.split("").map(a=>a.charCodeAt(0));for(let e=0;e<b.length;e++)d[e]<a.length?a=a.slice(0,d[e])+b[e]+a.slice(d[e]):a+=b[e];return a},pullCheckSum:(a,b,c)=>{for(;c.length<b;)c+=c;c=c.slice(0,b);var d=c.split("").map(a=>a.charCodeAt(0)).reverse(),e="";for(let f=0;f<b;f++)d[f]<a.length?(e+=a[d[f]],a=a.slice(0,d[f])+a.slice(d[f]+1)):(e+=a[a.length-1],a=a.slice(0,-1));return e=e.split("").reverse().join(""),[a,e]},vigenere:(a,b,c)=>{b=b.length<=a.length?b:b.slice(0,a.length);let d=0;var e="";for(let f=0;f<a.length;f++)if(privateSave.vigenereAlphabet.includes(a[f])){let g=privateSave.vigenereAlphabet.indexOf(a[f]),h=privateSave.vigenereAlphabet.indexOf(b[(f-d)%b.length]);c?(g-=h,0>g&&(g+=privateSave.vigenereAlphabet.length)):g=(g+h)%privateSave.vigenereAlphabet.length,e+=privateSave.vigenereAlphabet[g]}else e+=a[f],d++;return e},encodeBin:(a,b)=>{if("number"!=typeof b)return a;b=b.toString();var c="";a=a.toString();for(let d=0;d<a.length;d++){let e=a.charCodeAt(d),f=e^b;c+=String.fromCharCode(f)}return c},verify:(a,b,c,d)=>{a=a.includes("\n")?a.split("\n")[0]:a;let e=a.includes("Filename")?a.slice(21,57).trim():a.slice(12,48).trim();return b=!b||!a.includes("Filename"),d=!!d&&"Saved Game"!==a.slice(1,11).trim(),"("!==a[0]||" "!==a[6]||" "!==a[11]||d?(c&&privateSave.openDialog("This is not a Twine save... is it?"),"corrupted_save_name"):e===privateSave.storyUID?!!b||"wrong_save_key":(c&&privateSave.openDialog("I can't open this save, it's from another Twine game!"),"wrong_id")},process:(a,b,c,d)=>new Promise((e,f)=>{c=Array.isArray(c)?c:[c];var g=a.files[a.files.length-1];if(g.name.slice(g.name.lastIndexOf(".")+1).toLowerCase()!==privateSave.extension)return privateSave.openDialog("Wrong extension, correct one is: ."+privateSave.extension),void f("wrong_extension");if(!g||g.size/1024>privateSave.maxFileSize)return privateSave.openDialog("File too large (or your browser couldn'y provide it)"),void f("none/too_large");var h=new FileReader;h.readAsText(g),h.onload=a=>{let g=a.target.result;if(50>=g.length)return privateSave.openDialog("Empty/too short file!"),void f("empty/too_short");if(g=privateSave.decode(g),Array.isArray(g))return void f(g[1]);if("Saved Game"!==g.slice(1,11))return privateSave.openDialog("I can't load this save - is this even a save file?"),void f("no_phrase");var h=g.split("\n");if(2>h.length)return privateSave.openDialog("I can't load this save - can't unpack it!"),void f("no_line_break");let i=h[0];var j=i.slice("49").trim();if(c.includes(j)){const a=State.deserialise(d,h[1]);a instanceof Error?(console.error(a),privateSave.openDialog("Save corrupted - Twine refused loading it!"),f("corrupted_save_data")):(localStorage.setItem("(Saved Game "+privateSave.storyUID+") "+b,h[1]),e(!0))}else privateSave.openDialog("I'm not allowed to load this save!"),f("wrong_slot")},h.onerror=()=>{privateSave.openDialog("Error reading the file!"),f("file_error")}}),file:(a,b)=>{var c=privateSave.get(b);c?(c=privateSave.encode(c),privateSave.download(c,"text/plain",a+"."+privateSave.extension)):(privateSave.openDialog("I can't download save which doesn't exists!"),console.error(...privateSave.appPrefix,"I can't download save which doesn't exists!"))},fileDirect:(a,b)=>{let c=privateSave.getDirect(b);return"null"==typeof c?(privateSave.openDialog("I couldn't download save - probably Twine's error!"),null):void(c=privateSave.encode(c),privateSave.download(c,"text/plain",a+"."+privateSave.extension))},read:(a,b,c)=>{var d=saveInput;d||(d=document.createElement("input"),d.setAttribute("type","file"),d.setAttribute("id","saveupload"),d.style.display="none",d.setAttribute("accept","."+privateSave.extension),d.setAttribute("size","1"),d.addEventListener("change",()=>{privateSave.process(d,a,b,c).then(()=>{d.remove(),saveInput=void 0,Engine.showPassage(State.passage),console.log(...privateSave.appPrefix,"Reading from file succesfull")}).catch(a=>{d.remove(),saveInput=void 0,console.error(...privateSave.appPrefix,"Error reading from file:",a),"cheater"==a&&(privateSave.cheatPassage?Engine.goToPassage(privateSave.cheatPassage):privateSave.openDialog("Oszust!"))})},{once:!0}),saveInput=d),d.click()},vigenereAlphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",storyUID:document.querySelector("tw-storydata").getAttribute("ifid"),appPrefix:["%cSAVE TO FILE:","font-weight: bold"]};Object.freeze(privateSave),console.info(privateSave.appPrefix[0]+"%c Save to file script is ready!",privateSave.appPrefix[1],"color: green;");const Macros=require("macros"),TwineError=require("internaltypes/twineerror"),TwineNotifier=require("internaltypes/twinenotifier");Macros.add("readfromfile",function(a){let b="";console.log(a);for(var c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];if(0<d.length){let b=[];b=1<d.length?d.slice(1,d.length):[d[0]],privateSave.read(d[0],b,a)}return Engine.options.debug&&(b+="(readfromfile:"+d.toString()+")"),{TwineScript_TypeName:"a (readfromfile:) operation",TwineScript_ObjectName:"a (readfromfile:) operation",TwineScript_Print:function(){return b&&TwineNotifier.create(b).render()[0].outerHTML}}},[String,Macros.TypeSignature.zeroOrMore(String)]),Macros.add("savetofile",function(a,b,c){let d="";return(b=b.trim(),""===b||""===c)?TwineError.create("macrocall","This macro does not accept empty strings!"):(privateSave.file(b,c),Engine.options.debug&&(d+="(savetofile:"+b+", "+c+")"),{TwineScript_TypeName:"a (savetofile:) operation",TwineScript_ObjectName:"a (savetofile:) operation",TwineScript_Print:function(){return d&&TwineNotifier.create(d).render()[0].outerHTML}})},[String,String]),Macros.add("savetofiledirect",function(a,b,c){let d="";return(b=b.trim(),""===b||""===c)?TwineError.create("macrocall","This macro does not accept empty strings!"):(privateSave.fileDirect(b,c),Engine.options.debug&&(d+="(savetofiledirect:"+b+", "+c+")"),{TwineScript_TypeName:"a (savetofiledirect:) operation",TwineScript_ObjectName:"a (savetofiledirect:) operation",TwineScript_Print:function(){return d&&TwineNotifier.create(d).render()[0].outerHTML}})},[String,String]);